{% extends "base.html" %}

{% block head %}
<style>
    .feature-card {
        background: rgba(26, 26, 46, 0.6);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .feature-card:hover {
        border-color: var(--neon-cyan);
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        transform: translateY(-5px);
    }
    
    .feature-label { 
        color: var(--neon-cyan); 
        font-weight: 600; 
        font-size: 0.9rem; 
        margin-bottom: 5px; 
    }
    
    .feature-value { 
        color: var(--text-primary); 
        font-size: 1.2rem; 
        font-weight: 700; 
    }
    
    .extracted-field {
        background-color: #e7f3ff !important;
        border: 1px solid #4a90e2 !important;
    }
    
    /* Make alert text white */
    .alert {
        color: var(--text-primary) !important;
    }
    
    .alert-success {
        background-color: rgba(0, 255, 136, 0.2);
        border-color: rgba(0, 255, 136, 0.5);
    }
    
    .alert-info {
        background-color: rgba(0, 255, 255, 0.2);
        border-color: rgba(0, 255, 255, 0.5);
    }
    
    .alert-warning {
        background-color: rgba(255, 193, 7, 0.2);
        border-color: rgba(255, 193, 7, 0.5);
    }
    
    .alert-danger {
        background-color: rgba(255, 0, 110, 0.2);
        border-color: rgba(255, 0, 110, 0.5);
    }
    
    /* Make radio button labels white */
    .form-check-label {
        color: var(--text-primary) !important;
    }
    
    .form-label {
        color: var(--text-primary) !important;
    }
    
    /* Enhanced slider value display to match original design */
    .slider-value {
        background: rgba(0, 255, 255, 0.25) !important;
        border: 2px solid var(--neon-cyan) !important;
        border-radius: 12px !important;
        color: var(--neon-cyan) !important;
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.4),
                    0 4px 12px rgba(0, 0, 0, 0.35) !important;
        text-shadow: 0 0 5px rgba(0, 255, 255, 0.6) !important;
        padding: 10px 18px !important;
        min-width: 120px !important;
    }
    
    /* Ensure slider container has proper spacing */
    .slider-container {
        margin-bottom: 30px;
    }
    
    /* Make sure input fields are properly styled */
    .slider-input input[type="number"] {
        background: rgba(26, 26, 46, 0.8) !important;
        border: 2px solid rgba(0, 255, 255, 0.3) !important;
        color: var(--text-primary) !important;
    }
    
    .slider-input input[type="number"]:focus {
        border-color: var(--neon-cyan) !important;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="jumbotron">
            <h1 class="display-4">Predict Credit Score</h1>
            <p class="lead">Fill in the form below to predict your company's credit score and risk category using our advanced AI model.</p>
        </div>
    </div>
</div>

<!-- Mode Selection -->
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-cog"></i> Select Input Mode</h4>
            </div>
            <div class="card-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="inputMode" id="modeNewEntry" value="new_entry">
                    <label class="form-check-label" for="modeNewEntry">
                        <strong>New Entry – Upload Financial Report PDF</strong>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="inputMode" id="modeExisting" value="existing_company">
                    <label class="form-check-label" for="modeExisting">
                        <strong>Existing Company – Retrieve From Database</strong>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PDF Upload Section (New Entry Mode) -->
<div class="row" id="pdfUploadSection" style="display: none;">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-file-pdf"></i> Upload Financial Report PDF</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="pdfFile" class="form-label">Select PDF File</label>
                    <input type="file" class="form-control" id="pdfFile" accept=".pdf">
                    <small class="form-text text-muted">Upload a PDF containing your financial report. All fields will be automatically extracted.</small>
                </div>
                <button type="button" class="btn btn-primary" id="uploadPdfBtn">
                    <i class="fas fa-upload"></i> Upload and Extract
                </button>
                <div id="pdfUploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Existing Company Search Section -->
<div class="row" id="existingCompanySection" style="display: none;">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-search"></i> Search Existing Company</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <div class="mb-3">
                            <label for="searchCompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="searchCompanyName" placeholder="Enter company name">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="mb-3">
                            <label for="searchOwnerName" class="form-label">Owner Name</label>
                            <input type="text" class="form-control" id="searchOwnerName" placeholder="Enter owner name">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-100" id="searchCompanyBtn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                <div id="companySearchStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Company and Owner Information Display -->
<div class="row" id="companyInfoSection" style="display: none;">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-building"></i> Company Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="feature-card">
                            <div class="feature-label">Company Name</div>
                            <div class="feature-value" id="displayCompanyName">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-card">
                            <div class="feature-label">Owner Name</div>
                            <div class="feature-value" id="displayOwnerName">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Difference Summary Section -->
<div class="row" id="differenceSummarySection" style="display: none;">
    <div class="col-md-12">
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning">
                <h4><i class="fas fa-exchange-alt"></i> Changes Detected</h4>
            </div>
            <div class="card-body" id="differenceSummaryContent">
                <!-- Difference summary will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Financial Information Form -->
<div class="row" id="financialFormSection" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-calculator"></i> Financial Information</h4>
            </div>
            <div class="card-body">
                <form id="predictForm">
                    <input type="hidden" id="inputMode" name="mode" value="">
                    <input type="hidden" id="ownerNameField" name="owner_name" value="">
                    <input type="hidden" id="extractedCompanyNameField" name="extracted_company_name" value="">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Monthly_Inflow" class="form-label">
                                    <i class="fas fa-arrow-down"></i> Monthly Inflow (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Monthly_Inflow_slider" 
                                               min="0" max="1000000" step="1000" value="50000">
                                    </div>
                                    <input type="number" class="form-control" id="Monthly_Inflow" 
                                           name="Monthly_Inflow" min="0" step="0.01" value="50000" required>
                                    <span class="slider-value">₹<span id="Monthly_Inflow_value">50,000</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Monthly_Outflow" class="form-label">
                                    <i class="fas fa-arrow-up"></i> Monthly Outflow (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Monthly_Outflow_slider" 
                                               min="0" max="1000000" step="1000" value="40000">
                                    </div>
                                    <input type="number" class="form-control" id="Monthly_Outflow" 
                                           name="Monthly_Outflow" min="0" step="0.01" value="40000" required>
                                    <span class="slider-value">₹<span id="Monthly_Outflow_value">40,000</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Gst_compliance_score" class="form-label">
                                    <i class="fas fa-check-circle"></i> GST Compliance Score (0-100)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Gst_compliance_score_slider" 
                                               min="0" max="100" step="1" value="75">
                                    </div>
                                    <input type="number" class="form-control" id="Gst_compliance_score" 
                                           name="Gst_compliance_score" min="0" max="100" step="0.01" value="75" required>
                                    <span class="slider-value"><span id="Gst_compliance_score_value">75</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Ecommerce_sales" class="form-label">
                                    <i class="fas fa-shopping-cart"></i> E-commerce Sales (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Ecommerce_sales_slider" 
                                               min="0" max="500000" step="1000" value="20000">
                                    </div>
                                    <input type="number" class="form-control" id="Ecommerce_sales" 
                                           name="Ecommerce_sales" min="0" step="0.01" value="20000" required>
                                    <span class="slider-value">₹<span id="Ecommerce_sales_value">20,000</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Supplier_payments" class="form-label">
                                    <i class="fas fa-handshake"></i> Supplier Payments (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Supplier_payments_slider" 
                                               min="0" max="500000" step="1000" value="30000">
                                    </div>
                                    <input type="number" class="form-control" id="Supplier_payments" 
                                           name="Supplier_payments" min="0" step="0.01" value="30000" required>
                                    <span class="slider-value">₹<span id="Supplier_payments_value">30,000</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Invoice_issued" class="form-label">
                                    <i class="fas fa-file-invoice"></i> Number of Invoices Issued
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Invoice_issued_slider" 
                                               min="0" max="1000" step="1" value="50">
                                    </div>
                                    <input type="number" class="form-control" id="Invoice_issued" 
                                           name="Invoice_issued" min="0" value="50" required>
                                    <span class="slider-value"><span id="Invoice_issued_value">50</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Invoice_amount" class="form-label">
                                    <i class="fas fa-file-invoice-dollar"></i> Average Invoice Amount (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Invoice_amount_slider" 
                                               min="0" max="50000" step="100" value="1000">
                                    </div>
                                    <input type="number" class="form-control" id="Invoice_amount" 
                                           name="Invoice_amount" min="0" step="0.01" value="1000" required>
                                    <span class="slider-value">₹<span id="Invoice_amount_value">1,000</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Employee_count" class="form-label">
                                    <i class="fas fa-users"></i> Employee Count
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Employee_count_slider" 
                                               min="0" max="500" step="1" value="25">
                                    </div>
                                    <input type="number" class="form-control" id="Employee_count" 
                                           name="Employee_count" min="0" value="25" required>
                                    <span class="slider-value"><span id="Employee_count_value">25</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Asset_value" class="form-label">
                                    <i class="fas fa-building"></i> Asset Value (₹)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Asset_value_slider" 
                                               min="0" max="5000000" step="10000" value="500000">
                                    </div>
                                    <input type="number" class="form-control" id="Asset_value" 
                                           name="Asset_value" min="0" step="0.01" value="500000" required>
                                        <span class="slider-value">₹<span id="Asset_value_value">500,000</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="slider-container">
                                <label for="Business_age" class="form-label">
                                    <i class="fas fa-calendar-alt"></i> Business Age (Years)
                                </label>
                                <div class="slider-input">
                                    <div class="slider-wrapper">
                                        <input type="range" class="slider" id="Business_age_slider" 
                                               min="0" max="50" step="0.1" value="5">
                                    </div>
                                    <input type="number" class="form-control" id="Business_age" 
                                           name="Business_age" min="0" step="0.1" value="5" required>
                                    <span class="slider-value"><span id="Business_age_value">5</span> years</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="Business_size" class="form-label">
                            <i class="fas fa-chart-bar"></i> Business Size
                        </label>
                        <select class="form-select" id="Business_size" name="Business_size" required>
                            <option value="">Select Business Size</option>
                            <option value="micro">Micro</option>
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                        </select>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-rocket"></i> Predict Credit Score
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentMode = null;
    let lastPrediction = null;
    
    // Function to format numbers with commas (no decimals for currency)
    function formatNumber(num) {
        const numValue = Math.round(parseFloat(num) || 0);
        return numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    // Function to sync slider and input
    function syncSliderInput(sliderId, inputId, valueId, isCurrency = false, isPercentage = false) {
        const slider = document.getElementById(sliderId);
        const input = document.getElementById(inputId);
        const valueDisplay = document.getElementById(valueId);
        
        if (!slider || !input || !valueDisplay) return;
        
        // Update input and display when slider changes
        slider.addEventListener('input', function() {
            input.value = this.value;
            if (isCurrency) {
                valueDisplay.textContent = formatNumber(parseFloat(this.value));
            } else if (isPercentage) {
                valueDisplay.textContent = this.value;
            } else if (sliderId.includes('Business_age')) {
                valueDisplay.textContent = parseFloat(this.value).toFixed(1);
            } else {
                valueDisplay.textContent = formatNumber(this.value);
            }
        });
        
        // Update slider and display when input changes
        input.addEventListener('input', function() {
            const val = parseFloat(this.value) || 0;
            slider.value = val;
            if (isCurrency) {
                valueDisplay.textContent = formatNumber(val);
            } else if (isPercentage) {
                valueDisplay.textContent = this.value;
            } else if (inputId.includes('Business_age')) {
                valueDisplay.textContent = val.toFixed(1);
            } else {
                valueDisplay.textContent = formatNumber(this.value);
            }
        });
    }
    
    // Sync all sliders and inputs
    syncSliderInput('Monthly_Inflow_slider', 'Monthly_Inflow', 'Monthly_Inflow_value', true);
    syncSliderInput('Monthly_Outflow_slider', 'Monthly_Outflow', 'Monthly_Outflow_value', true);
    syncSliderInput('Gst_compliance_score_slider', 'Gst_compliance_score', 'Gst_compliance_score_value', false, true);
    syncSliderInput('Ecommerce_sales_slider', 'Ecommerce_sales', 'Ecommerce_sales_value', true);
    syncSliderInput('Supplier_payments_slider', 'Supplier_payments', 'Supplier_payments_value', true);
    syncSliderInput('Invoice_issued_slider', 'Invoice_issued', 'Invoice_issued_value');
    syncSliderInput('Invoice_amount_slider', 'Invoice_amount', 'Invoice_amount_value', true);
    syncSliderInput('Employee_count_slider', 'Employee_count', 'Employee_count_value');
    syncSliderInput('Asset_value_slider', 'Asset_value', 'Asset_value_value', true);
    syncSliderInput('Business_age_slider', 'Business_age', 'Business_age_value');
    
    // Handle mode selection
    function handleModeSelection() {
        const modeRadios = document.querySelectorAll('input[name="inputMode"]');
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                currentMode = this.value;
                document.getElementById('inputMode').value = currentMode;
                
                // Hide all sections first
                document.getElementById('pdfUploadSection').style.display = 'none';
                document.getElementById('existingCompanySection').style.display = 'none';
                document.getElementById('financialFormSection').style.display = 'none';
                document.getElementById('differenceSummarySection').style.display = 'none';
                
                // Show appropriate section based on mode
                if (currentMode === 'new_entry') {
                    document.getElementById('pdfUploadSection').style.display = 'block';
                } else if (currentMode === 'existing_company') {
                    document.getElementById('existingCompanySection').style.display = 'block';
                }
            });
        });
    }
    
    // Handle PDF upload
    function handlePDFUpload() {
        const uploadBtn = document.getElementById('uploadPdfBtn');
        const pdfFile = document.getElementById('pdfFile');
        const statusDiv = document.getElementById('pdfUploadStatus');
        
        uploadBtn.addEventListener('click', function() {
            const file = pdfFile.files[0];
            if (!file) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please select a PDF file.</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf_file', file);
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            statusDiv.innerHTML = '<div class="alert alert-info">Uploading and extracting data...</div>';
            
            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert alert-success">PDF processed successfully! Form fields have been auto-filled.</div>';
                    populateFormFields(data.company_profile, data.identity, 'new_entry');
                    document.getElementById('financialFormSection').style.display = 'block';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message || 'Failed to process PDF'}</div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload and Extract';
            });
        });
    }
    
    // Handle existing company search
    function handleExistingCompanySearch() {
        const searchBtn = document.getElementById('searchCompanyBtn');
        const statusDiv = document.getElementById('companySearchStatus');
        
        searchBtn.addEventListener('click', function() {
            const companyName = document.getElementById('searchCompanyName').value.trim();
            const ownerName = document.getElementById('searchOwnerName').value.trim();
            
            if (!companyName) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter company name.</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('company_name', companyName);
            formData.append('owner_name', ownerName);
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            statusDiv.innerHTML = '<div class="alert alert-info">Searching for company...</div>';
            
            fetch('/auto_fill_existing', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert alert-success">Company found! Form fields have been auto-filled.</div>';
                    lastPrediction = data.last_prediction;
                    populateFormFields(data.company_profile, data.identity, 'existing_company');
                    document.getElementById('financialFormSection').style.display = 'block';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message || 'Company not found'}</div>`;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            })
            .finally(() => {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            });
        });
    }
    
    // Populate form fields from data
    function populateFormFields(profile, identity, mode) {
        // Set mode
        document.getElementById('inputMode').value = mode;
        currentMode = mode;
        
        // Set owner name if available
        if (identity && identity.owner_name) {
            document.getElementById('ownerNameField').value = identity.owner_name;
        }
        
        // Set extracted company name if available
        if (identity) {
            const extractedCompanyName = identity.extracted_company_name || identity.company_name;
            if (extractedCompanyName) {
                document.getElementById('extractedCompanyNameField').value = extractedCompanyName;
            }
        }
        
        // Display company and owner information
        if (identity) {
            const displayCompanyName = identity.extracted_company_name || identity.company_name || '-';
            document.getElementById('displayCompanyName').textContent = displayCompanyName;
            document.getElementById('displayOwnerName').textContent = identity.owner_name || '-';
            document.getElementById('companyInfoSection').style.display = 'block';
        }
        
        // Map profile fields to form fields (convert snake_case to PascalCase)
        const fieldMapping = {
            'monthly_inflow': 'Monthly_Inflow',
            'monthly_outflow': 'Monthly_Outflow',
            'gst_compliance_score': 'Gst_compliance_score',
            'ecommerce_sales': 'Ecommerce_sales',
            'supplier_payments': 'Supplier_payments',
            'invoice_issued': 'Invoice_issued',
            'invoice_amount': 'Invoice_amount',
            'employee_count': 'Employee_count',
            'asset_value': 'Asset_value',
            'business_age': 'Business_age',
            'business_size': 'Business_size'
        };
        
        // Populate each field
        Object.keys(fieldMapping).forEach(profileKey => {
            const formKey = fieldMapping[profileKey];
            const value = profile[profileKey];
            
            if (value !== null && value !== undefined) {
                const input = document.getElementById(formKey);
                const slider = document.getElementById(formKey + '_slider');
                
                if (input) {
                    input.value = value;
                    // Trigger input event to update slider and display
                    input.dispatchEvent(new Event('input'));
                }
                if (slider) {
                    slider.value = value;
                    slider.dispatchEvent(new Event('input'));
                }
                
                // Add extracted-field class to highlight
                if (input) {
                    input.classList.add('extracted-field');
                    input.parentElement.classList.add('extracted-field');
                }
            }
        });
    }
    
    // Show difference summary
    function showDifferenceSummary(diffData) {
        if (!diffData || !diffData.changed_fields || Object.keys(diffData.changed_fields).length === 0) {
            return;
        }
        
        const section = document.getElementById('differenceSummarySection');
        const content = document.getElementById('differenceSummaryContent');
        
        let html = '<div class="row"><div class="col-md-12">';
        html += `<h5>Score Change: <span class="badge ${diffData.score_change >= 0 ? 'bg-success' : 'bg-danger'}">${diffData.score_change > 0 ? '+' : ''}${diffData.score_change}</span></h5>`;
        html += '<h6 class="mt-3">Changed Fields:</h6>';
        html += '<table class="table table-sm table-bordered">';
        html += '<thead><tr><th>Field</th><th>Old Value</th><th>New Value</th></tr></thead><tbody>';
        
        Object.keys(diffData.changed_fields).forEach(field => {
            const change = diffData.changed_fields[field];
            html += `<tr><td><strong>${field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></td>`;
            html += `<td>${change.old !== null && change.old !== undefined ? change.old : 'N/A'}</td>`;
            html += `<td>${change.new !== null && change.new !== undefined ? change.new : 'N/A'}</td></tr>`;
        });
        
        html += '</tbody></table></div></div>';
        content.innerHTML = html;
        section.style.display = 'block';
    }
    
    // Handle form submission
    function handlePrediction() {
        const form = document.getElementById('predictForm');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentMode) {
                alert('Please select an input mode first.');
                return;
            }
            
            const formData = new FormData(form);
            formData.append('mode', currentMode);
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            fetch('/save_prediction', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show difference summary if available
                    if (data.difference_summary) {
                        showDifferenceSummary(data.difference_summary);
                    }
                    // Redirect to prediction result
                    window.location.href = `/prediction_result/${data.prediction_id}`;
                } else {
                    alert(`Error: ${data.message || 'Failed to save prediction'}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Initialize all handlers
    handleModeSelection();
    handlePDFUpload();
    handleExistingCompanySearch();
    handlePrediction();
    
    // Add CSS for extracted fields
    const style = document.createElement('style');
    style.textContent = `
        .extracted-field {
            background-color: rgba(231, 243, 255, 0.2) !important;
            border: 1px solid #4a90e2 !important;
            color: var(--text-primary) !important;
        }
        .extracted-field::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        /* Ensure all text in form is white */
        .form-control, .form-select {
            color: var(--text-primary) !important;
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
